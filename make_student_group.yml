# This script is supposed to create users for student group passed in the create_group variable
---

  - hosts: 127.0.0.1
    remote_user: root

    tasks:
    - name: create group
      group: name={{create_group}} state=present system=no
    
    - name: Make group directory
      file: group=students owner=root mode=0755 path=/afs/dcti.sut.ru/homes/students/{{create_group}} state=directory
    
    - name: Add the users itself
      user: createhome=yes generate_ssh_key=yes group=students groups={{create_group}} home=/afs/dcti.sut.ru/homes/students/{{create_group}}/{{item}} name={{item}} shell=/bin/bash state=present system=no
      with_sequence: start=0 end=40 stride=1 format={{create_group}}n%02d
    
    - name: Make home directory
      file: group={{create_group}} owner={{item}} mode=0750 path=/afs/dcti.sut.ru/homes/students/{{create_group}}/{{item}} state=directory
      with_sequence: start=0 end=40 stride=1 format={{create_group}}n%02d

    - name: add kerberos principal
      script: scripts/create_principal.sh students {{item}}
      with_sequence: start=0 end=40 stride=1 format={{create_group}}n%02d

    - name: Update database for password resetter script
      command: sqlite3 /var/www/selfreg/database.sqlite3 'insert or ignore into "users" (username, fio, studnum) values ( "{{item}}", "","");insert or ignore into "quota" (username, usedspace, softlimit) values ( "{{item}}", 0, 0);'
      with_sequence: start=0 end=40 stride=1 format={{create_group}}n%02d

    - name: Patch passwd  # to replace password field with *K*
      command: sed 's/^{{item}}:x:/{{item}}:*K*:/' -i /etc/passwd
      with_sequence: start=0 end=40 stride=1 format={{create_group}}n%02d

    - name: Setup quota
      command: setquota -u {{item}} 3000000 350000 0 0 /home
      with_sequence: start=0 end=40 stride=1 format={{create_group}}n%02d

    - name: Setup svn server 1
      file: path=/srv/svn/{{create_group}} state=directory

    - name: Setup svn server 2
      command: svnadmin create /srv/svn/{{create_group}}

    - name: Setup svn server 3
      command: cp /srv/svn/sandbox/conf/svnserve.conf /srv/svn/{{create_group}}/conf
