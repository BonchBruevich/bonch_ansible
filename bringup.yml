---
  - hosts: all
    vars:
      openntpd_ntp_servers: "timeserver.dcti.sut.ru"

    remote_user: root
    tasks:
    - include: tasks/fixpartitionsizes.yml
    - include: tasks/addscratch.yml
    - include: tasks/enable_kerberos_ssh.yml

    - include: tasks/add_i386_architecture_support.yml

    - include: tasks/addlocalrepo.yml
    - include: tasks/addstretchbackports.yml
    - include: tasks/aptgetupdate.yml
    - include: tasks/create_rc_local.yml
    - include: tasks/logrotate.yml

    - name: add pam_group to configs
      lineinfile: dest=/etc/pam.d/common-auth line="auth optional pam_group.so" state=present insertafter=EOF

    - name: install autofs packages
      apt:
        name:
          - autofs
        state: installed

    - name: update autofs config
      lineinfile: dest=/etc/auto.master line="/net    /etc/auto.net" insertbefore="\+auto.master"
      notify: restart autofs

    - name: make /afs directory
      file: dest=/afs state=directory mode=0755 owner=root group=root

    - name: restart autofs
      service: name=autofs state=restarted

    - name: link /net/eniac.dcti.sut.ru int /afs/dcti.sut.ru
      file: dest=/afs/dcti.sut.ru src=/net/eniac.dcti.sut.ru/srv/nfs4/homes/ owner=root group=root mode=644 state=link force=yes follow=no

    - name: deploy nsswitch configuration files
      copy: src=files/a441/etc/hesiod.conf dest=/etc/hesiod.conf owner=root group=root mode="0644"

    - name: deploy hesiod configuration files
      copy: src=files/a441/etc/nsswitch.conf dest=/etc/nsswitch.conf owner=root group=root mode="0644"

    - name: deploy kerberos configuration files
      copy: src=files/a441/etc/krb5.conf dest=/etc/krb5.conf owner=root group=root mode="0644"

    - name: deploy admin access
      copy: src=files/a441/root/.k5login dest=/root/.k5login owner=root group=root mode="0644"

    - name: add pam group config
      copy: src=files/a441/etc/security/group.conf dest=/etc/security/group.conf owner=root group=distrib mode="0664"

#    - name: fix pam configs for auth
#      copy: src=files/a441/etc/pam.d/common-auth dest=/etc/pam.d/commion-auth owner=root group=root mode="0644"

    - include: tasks/install_dosemu.yml
    - include: tasks/fix_autofs_systemd.yml

    - name: install base packages
      apt:
        pkg:
         - lightdm
         - xserver-xorg
         - x11-xserver-utils
        state: installed
      notify: restart lightdm

    - name: install linux linux-headers
      apt: pkg=linux-headers-{{ ansible_kernel }} state=installed

    - name: install DCTI packages
      notify: restart apache
      apt:
        pkg:
         - nfs4-acl-tools
         - trash-cli
         - firmware-realtek
         - pm-utils
         - upower
         - x11-xserver-utils
         - aptitude
         - imagemagick
         - dia
         - dia2code
         - doxygen
         - graphviz
         - runit
         - mc
         - unburden-home-dir
         - tcsh
         - pmount
         - scribus
         - librecad
         - ristretto
         - libsasl2-modules-gssapi-mit
         - policykit-1-gnome
         - udisks2
         - ntfs-3g
         - eject
         - gvfs
#         - thunar-archive-plugin
#         - thunar-vcs-plugin
#         - thunar-volman
         - xdg-user-dirs
         - dosfstools
         - eric
         - eric-api-files
         - python3-pyqt5.qtwebengine
         - python3-rope
         - pyqt5-dev-tools
         - python-doc
         - python3-doc
         - inkscape
         - xterm
         - rxvt-unicode-256color
         - fakeroot
         - gnome-extra-icons
         - gnome-icon-theme
         - build-essential
         - dfu-util
         - minicom
         - gimp
         - gimp-plugin-registry
         - xsane
         - vim
         - vim-gtk
         - gdb
         - ruby
         - evince
         - nasm
         - x11-utils
         - gedit
         - gedit-plugins
         - firmware-linux
         - pidgin
         - gtk3-nocsd
        state: installed
        install_recommends: no
        update_cache: yes

    - include: tasks/install_virtualbox.yml

    - name: install DCTI packages for debian 9
      when: ansible_distribution == 'Debian' and ansible_distribution_major_version == '9'
      notify: restart apache
      apt:
        pkg:
         - libpam-ck-connector
         - xfce4
         - xfwm4-themes
         - xfdesktop4
  #       - xfprint4
         - libxfce4ui-utils
         - xfce4-mount-plugin
         - xfce4-goodies
         - xfce4-session
         - lazarus
         - fpc
        state: installed
        install_recommends: no
        update_cache: no


    - name: install mate desktop
      apt: pkg=mate-desktop-environment state=installed update_cache=no
    - name: install mate-tweak
      apt: pkg=mate-tweak state=installed install_recommends=no update_cache=no

    - include: tasks/install_libreoffice.yml
    - include: tasks/install_msttfcorefonts.yml
    - include: tasks/install_fonts_terminus.yml
    - include: tasks/install_jdk.yml
    - include: tasks/installvnc.yml
    - include: tasks/install_apache2_and_php5.yml
    - include: tasks/install_lisp.yml
    - include: tasks/install_verilog.yml
    - include: tasks/install_swiprolog.yml
    - include: tasks/installcodeblocks.yml
    - include: tasks/installwebstormclion.yml
    - include: tasks/installvnc.yml
    - include: tasks/install_netbeans.yml
    - include: tasks/install_subversion_git.yml
    - include: tasks/install_archive_tools.yml
    - include: tasks/enable_quota_applet.yml
    - include: tasks/install_browser_pack.yml
    - include: tasks/install_maxima.yml
    - include: tasks/install_sql_databases.yml
    - include: tasks/installhaskell.yml
    - include: tasks/install_qtsdk.yml
    - include: tasks/install_octave.yml
    - include: tasks/install_monodevelop.yml
    - include: tasks/install_ipython.yml
    - include: tasks/install_icecc.yml
    - include: tasks/installwebstormclion.yml
    - include: tasks/install_rustc.yml
    - include: tasks/install_golang.yml
    - include: tasks/installnscd.yml
    - include: tasks/fixxsessionerrors.yml
    - include: tasks/install_quartus_7_1.yml
    - name: install x11vnc to allow remote access
      apt: pkg=x11vnc state=installed update_cache=no install_recommends=no

    - name: deploy dosemu autoexec.bat
      copy: src=files/common/etc/dosemu/freedos/autoexec.bat dest=/etc/dosemu/freedos/autoexec.bat owner=root group=root mode="0644"

    - name: install packages for time sync
      apt:
        name:
         - openntpd
         - ntpdate
        state: installed
    - name: install qemu-system
      apt:
        pkg:
         - qemu-system
         - qemu-kvm
        state: installed
        install_recommends: no
        update_cache: no
    - name: install pulseaudio for audio access
      apt:
        pkg:
         - pulseaudio
         - pavucontrol
        state: installed
        install_recommends: no
        update_cache: no
    - name: Install openntpd config
      template: src=templates/etc_openntpd_ntpd.conf.j2 dest=/etc/openntpd/ntpd.conf
      notify: restart openntpd

    - name: Install openntpd defaults
      copy: src=files/a441/etc/default/openntpd dest=/etc/default/openntpd
      notify: restart openntpd

    - name: install lm-sensors
      apt: name=lm-sensors state=present install_recommends=no update_cache=no
    - name: install hddtemp
      apt: name=hddtemp state=present install_recommends=no update_cache=no

    - include: tasks/install_internet.yml
    - include: tasks/installjavatests.yml
    - include: tasks/fix_access_mysql.yml
    - name: install vncbroadcast to allow remote access
      apt: pkg=vncbroadcast state=latest update_cache=no install_recommends=no
    - name: Add vncbroadcast to autostart
      copy:
        src: /usr/share/applications/vncbroadcast.desktop
        dest: /etc/xdg/autostart/
        mode: 0755
        remote_src: yes

    handlers:
    - include: handlers/restartopenntpd.yml
    - include: handlers/restartlightdm.yml
    - include: handlers/restartautofs.yml
    - include: handlers/restartapache.yml

  - hosts: a44306.dcti.sut.ru
    remote_user: root
    tasks:
    - include: tasks/add_scanner_snapscan.yml

  - hosts: remoteprinters
    remote_user: root
    tasks:
    - include: tasks/add_remote_printer_access.yml

  - hosts: a445
    remote_user: root
    tasks:
    - include: tasks/install_quartus_15.yml

  - hosts: a439
    remote_user: root
    tasks:
    - include: tasks/install_quartus_15.yml

#  - hosts: a437
#    remote_user: root
#    tasks:
#    - include: tasks/install_quartus_15.yml
#    - name: install libpng12 for quartus
#      apt: name=libpng12-0 state=present install_recommends=no update_cache=no

  - hosts: a443
    remote_user: root
    tasks:
    - include: tasks/install_texlive.yml
    - include: tasks/install_texmaker.yml
    - include: tasks/install_quartus_15.yml
    - name: setup scanner
      action: lineinfile dest=/etc/sane.d/xerox_mfp.conf state=present line="tcp a517mfu 9400"
    - name: setup scanner
      action: lineinfile dest=/etc/sane.d/xerox_mfp.conf state=absent line="tcp a517mfu2 9400"
    - name: install sane-utils
      apt: pkg=sane-utils state=installed install_recommends=no update_cache=no

  - hosts: a441
    remote_user: root
    tasks:
    - include: tasks/install_quartus_15.yml
    - include: tasks/install_texlive.yml
    - include: tasks/install_texmaker.yml
    - name: setup scanner
      action: lineinfile dest=/etc/sane.d/xerox_mfp.conf state=absent line="tcp a517mfu2 9400"
    - name: setup scanner2
      action: lineinfile dest=/etc/sane.d/xerox_mfp.conf state=present line="tcp a517mfu 9400"
    - name: install sane-utils
      apt: pkg=sane-utils state=installed install_recommends=no update_cache=no

  - hosts: termserver2.dcti.sut.ru
    remote_user: root
    tasks:
    - include: tasks/install_texlive.yml
    - include: tasks/install_texmaker.yml
    - include: tasks/install_quartus_15.yml
    - name: install coquelicot-upload tool
      apt: pkg=coquelicot-upload state=latest update_cache=no

  - hosts: all
    remote_user: root
    tasks:
    - name: Mark completion
      file: path=/var/bringup_complete state=touch owner=root group=root mode=0644
