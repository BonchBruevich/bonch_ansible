---
  - hosts: all
    vars:
      openntpd_ntp_servers: "timeserver.dcti.sut.ru"
        
    remote_user: root
    tasks:
    - include: tasks/enable_kerberos_ssh.yml

    - name: add pam_group to configs
      lineinfile: dest=/etc/pam.d/common-auth line="auth optional pam_group.so" state=present insertafter=EOF
    
    - name: install autofs packages
      action: apt pkg={{item}} state=installed
      with_items:
       - autofs
    
    - name: update autofs config
      lineinfile: dest=/etc/auto.master line="/net    /etc/auto.net" insertbefore="\+auto.master"
      notify: restart autofs

    - name: make /afs directory
      file: dest=/afs state=directory mode=0755 owner=root group=root

    - name: link /net/eniac.dcti.sut.ru int /afs/dcti.sut.ru
      file: dest=/afs/dcti.sut.ru/ src=/net/eniac.dcti.sut.ru/srv/nfs4/homes/ owner=root group=root mode=644 state=link force=yes
    
    - name: deploy nsswitch configuration files
      copy: src=files/a441/etc/hesiod.conf dest=/etc/hesiod.conf owner=root group=root mode="0644"

    - name: deploy hesiod configuration files
      copy: src=files/a441/etc/nsswitch.conf dest=/etc/nsswitch.conf owner=root group=root mode="0644"
    
    - name: deploy kerberos configuration files
      copy: src=files/a441/etc/krb5.conf dest=/etc/krb5.conf owner=root group=root mode="0644"

    - name: deploy admin access
      copy: src=files/a441/root/.k5login dest=/root/.k5login owner=root group=root mode="0644"

    - name: add pam group config
      copy: src=files/a441/etc/security/group.conf dest=/etc/security/group.conf owner=root group=distrib mode="0664"

#    - name: fix pam configs for auth
#      copy: src=files/a441/etc/pam.d/common-auth dest=/etc/pam.d/commion-auth owner=root group=root mode="0644"

    - include: tasks/enable_quota_applet.yml
    - include: tasks/addlocalrepo.yml

    - name: install base packages
      action: apt pkg={{item}} state=installed
      with_items:
       - lightdm
       - xserver-xorg
      notify: restart lightdm

    - name: install linux linux-headers
      action: apt pkg=linux-headers-{{ansible_kernel}} state=installed

    - name: install DCTI packages
      action: apt pkg={{item}} state=installed install_recommends=no update_cache=yes
      notify: restart apache
      with_items:
       - imagemagick
       - dia
       - dia2code
       - doxygen
       - graphviz
       - runit
       - mc
       - unburden-home-dir
       - tcsh
       - pmount
       - scribus
       - librecad
       - ristretto
       - libsasl2-modules-gssapi-mit
       - xfce4
       - xfwm4-themes
       - xfce4-utils
       - xfce4-mount-plugin
       - xfce4-goodies
       - policykit-1-gnome
       - udisks
       - ntfs-3g
       - eject
       - gvfs
       - thunar-archive-plugin
       - thunar-vcs-plugin
       - thunar-volman
       - xdg-user-dirs
       - xfdesktop4
       - xfprint4
       - dosemu
       - dosfstools
       - ipython
       - ipython-notebook
       - eric
       - xfce4-session
       - inkscape
       - xterm
       - rxvt-unicode-256color
       - lazarus
       - fpc
       - virtualbox
       - virtualbox-qt
       - virtualbox-dkms
       - virtualbox-source
       - fakeroot
       - gnome-extra-icons
       - gnome-icon-theme
       - build-essential
       - dfu-util
       - minicom
       - gimp
       - gimp-plugin-registry
       - xsane
       - vim
       - vim-gtk
       - octave
       - qtoctave
       - gdb
       - ruby
       - evince-gtk
       - nasm
       - x11-utils
       - gedit
       - gedit-plugins
       - firmware-linux
       - pidgin
    
    - include: tasks/install_libreoffice.yml
    - include: tasks/install_jdk.yml
    - include: tasks/installvnc.yml
    - include: tasks/install_apache2_and_php5.yml
    - include: tasks/install_lisp.yml
    - include: tasks/install_swiprolog.yml
    - include: tasks/installcodeblocks.yml
    - include: tasks/installwebstormclion.yml
    - include: tasks/install_netbeans.yml
    - include: tasks/install_subversion_git.yml
    - include: tasks/install_archive_tools.yml
    - include: tasks/install_browser_pack.yml
    - include: tasks/install_maxima.yml
    - include: tasks/install_sql_databases.yml
    - include: tasks/installhaskell.yml
    - include: tasks/install_qtsdk.yml

    - name: deploy dosemu autoexec.bat
      copy: src=files/common/etc/dosemu/freedos/autoexec.bat dest=/etc/dosemu/freedos/autoexec.bat owner=root group=root mode="0644"

    - name: install packages for time sync
      action: apt name={{item}} state=installed
      with_items:
       - openntpd
       - ntpdate

    - name: Install openntpd config
      template: src=templates/etc_openntpd_ntpd.conf.j2 dest=/etc/openntpd/ntpd.conf
      notify: restart openntpd

    - name: Install openntpd defaults
      copy: src=files/a441/etc/default/openntpd dest=/etc/default/openntpd
      notify: restart openntpd

#    - name: add virtual machines mount point
#      mount: fstype=ext4 name=/vm passno=2 src=/dev/mapper/a515-win7tmp state=mounted
    - include: tasks/install_internet.yml

    handlers:
    - include: handlers/restartopenntpd.yml
    - include: handlers/restartlightdm.yml
    - include: handlers/restartautofs.yml
    - include: handlers/restartapache.yml
  
  - hosts: a44306.dcti.sut.ru
    remote_user: root
    tasks:
    - include: tasks/add_remote_printer_access.yml
    - include: tasks/add_scanner_snapscan.yml
