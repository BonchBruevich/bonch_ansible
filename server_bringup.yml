---

  - hosts: fileserver
    remote_user: ewg
    become: true
    gather_facts: true
    become_user: root
    become_method: ksu
    tasks:
    - name: install ansible
      apt: pkg=ansible state=present
    - include: tasks/copyansiblehosts.yml
    - include: tasks/installtemperaturereport.yml
#server cleanup
    - name: remove unneeded packages
      apt:
        pkg: "{{ item }}"
        state: absent
        purge: yes
      with_items:
        - firefox-esr
        - task-desktop
        - task-kde-desktop
        - kde-standard
        - network-manager
        - wpasupplicant
        - modemmanager
        - usb-modeswitch
        - plasma-desktop
        - plasma-workspace
        - dolphin
        - packagekit
        - pulseaudio
        - kdeconnect
        - milou
        - ipp-usb
        - avahi-daemon
#deploy file server TODO
#permission scripts not copied yet
    - include: tasks/servers/nfs_server.yml
#deploy dhcp TODO
    - include: tasks/servers/dhcp_server.yml
#Deploy email
    - include :tasks/servers/smtp_server.yml
#deploy email client and imap/pop3 TODO
#Deploy network boot service DONE
    - name: install inetd
      apt:
        pkg: inetutils-inetd
        state: present
        install_recommends: no
    - name: install atftpd
      apt:
        pkg: atftpd
        state: present
        install_recommends: no
    - name: make directory for boot files
      file:
        path: '/opt/tftpboot'
        state: directory
    - name: remove old directory for boot files
      file:
        path: '/srv/tftp'
        state: absent
    - name: deploy line into /etc/inetd.conf
      lineinfile:
        state: present
        line: 'tftp     dgram   udp4    wait    nobody /usr/sbin/tcpd /usr/sbin/in.tftpd --tftpd-timeout 300 --retry-timeout 5 --mcast-port 1758 --mcast-addr 239.239.239.0-255 --mcast-ttl 1 --maxthread 100 --verbose=5 /opt/tftpboot'
        path: /etc/inetd.conf
#Deploy ntp server DONE
    - name: install ntpd
      apt:
        pkg: ntp
        state: present
    - name: copy ntpd config file
      copy:
        src: files/servers/etc/ntp.conf
        dest: /etc/ntp.conf
        owner: root
        group: root
        mode: 0644
# Install cups TODO
# install rsync service DONE
    - name: install rsync
      apt:
        pkg: rsync
        state: present
    - name: copy rsync config file
      copy:
        src: files/servers/etc/rsyncd.conf
        dest: /etc/rsyncd.conf
        owner: root
        group: root
        mode: 0644
    - name: enable rsyncd
      lineinfile:
        state: present
        regex: '^RSYNC_ENABLE='
        line: 'RSYNC_ENABLE=true'
        path: /etc/default/rsync
    - name: create paths for rsync config
      file:
        path: '{{ item }}'
        state: directory
      with_items:
        - '/home/distrib/Linux/quartus/'
        - '/home/distrib/Linux/vm'
    - name: Restart rsync.service 
      systemd:
        daemon_reload: yes
        state: started
        name: rsync.service
# install apt-cacher-ng TODO
    - name: list files
      shell: "/usr/sbin/vgdisplay -c|head -n 1|awk -F: '{print $1}'|sed 's/^ *//g'"
      register: vgname
    - name: Add aptcacher lvm location
      action: lvol vg={{ vgname.stdout }} lv=aptcacher size=20G
    - name: Make filesystem on aptcacher volume
      action: filesystem fstype=ext4 dev=/dev/mapper/{{ vgname.stdout }}-aptcacher
    - name: Add scratch to fstab
      action: mount name=/var/cache/apt-cacher-ng src=/dev/mapper/{{ vgname.stdout }}-aptcacher state=mounted fstype=ext4
    - name: install apt-cacher-ng
      apt:
        pkg: apt-cacher-ng
        state: present
    # deploy configs: TODO
# install let'sencrypt certs manager TODO
# configure NGINX  TODO
# jetbrains license server TODO
# gitea TODO
# 1c license server TODO
# package repository management TODO
    - name: deploy aptly package management server
      apt:
        pkg: aptly
        state: present
    - name: make directory for bonch package repository files
      file:
        path: '/opt/bonch_repo_source'
        state: directory
    - name: copy aptly config file
      copy:
        src: files/servers/root/.aptly.conf
        dest: /root/.aptly.conf
        owner: root
        group: root
        mode: 0644
