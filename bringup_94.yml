---
  - hosts: all
    vars:
      openntpd_ntp_servers: "timeserver.dcti.sut.ru"
        
    remote_user: root
    tasks:
    - include: tasks/enable_kerberos_ssh.yml

    - name: add pam_group to configs
      lineinfile: dest=/etc/pam.d/common-auth line="auth optional pam_group.so" state=present insertafter=EOF
    
    - name: install autofs packages
      action: apt pkg={{item}} state=installed
      with_items:
       - autofs
    
    - name: update autofs config
      lineinfile: dest=/etc/auto.master line="/net    /etc/auto.net" insertbefore="\+auto.master"
      notify: restart autofs

    - name: make /afs directory
      file: dest=/afs state=directory mode=0755 owner=root group=root

    - name: link /net/eniac.dcti.sut.ru int /afs/dcti.sut.ru
      file: dest=/afs/dcti.sut.ru/ src=/net/eniac.dcti.sut.ru/srv/nfs4/homes/ owner=root group=root mode=644 state=link force=yes

    - name: enable quota applet
      action: apt pkg={{item}} state=installed
      with_items:
       - quota
       - python-glade2
#       - python-eggtrayicon

    - include: tasks/addlocalrepo.yml

    - name: install base packages
      action: apt pkg={{item}} state=installed
      with_items:
       - lightdm
       - xserver-xorg
      notify: restart lightdm

    - name: install linux linux-headers
      action: apt pkg=linux-headers-{{ansible_kernel}} state=installed

    - name: install DCTI packages
      action: apt pkg={{item}} state=installed install_recommends=no update_cache=yes
      notify: restart apache
      with_items:
       - firmware-realtek
       - pm-utils
       - upower
       - x11-xserver-utils
       - libpam-ck-connector
       - aptitude
       - imagemagick
       - dia
       - dia2code
       - doxygen
       - graphviz
       - runit
       - mc
       - unburden-home-dir
       - tcsh
       - pmount
       - scribus
       - librecad
       - ristretto
       - xtightvncviewer
       - libsasl2-modules-gssapi-mit
       - xfce4
       - xfwm4-themes
       - libxfce4ui-utils
       - xfce4-mount-plugin
       - xfce4-goodies
       - policykit-1-gnome
       - udisks2
       - ntfs-3g
       - eject
       - gvfs
       - thunar-archive-plugin
       - thunar-vcs-plugin
       - thunar-volman
       - xdg-user-dirs
       - xfdesktop4
#       - xfprint4
       - dosemu
       - dosfstools
       - codeblocks
       - ipython
       - eric
       - xfce4-session
       - inkscape
       - libreoffice
       - libreoffice-base
       - libreoffice-calc
       - libreoffice-draw
       - libreoffice-help-ru
       - libreoffice-l10n-ru
       - libreoffice-lightproof-ru-ru
       - libreoffice-impress
       - libreoffice-math
       - libreoffice-writer
       - libreoffice-nlpsolver
       - libreoffice-pdfimport
       - xterm
       - rxvt-unicode-256color
       - wxmaxima
       - maxima
       - maxima-share
       - lazarus
       - fpc
       - netsurf-gtk
       - iceweasel
       - chromium
       - virtualbox
       - virtualbox-qt
       - virtualbox-dkms
       - virtualbox-source
       - fakeroot
       - gnome-extra-icons
       - gnome-icon-theme
#       - netbeans=8.0.2.1
       - build-essential
       - dfu-util
       - subversion
       - git
       - gitk
       - git-gui
       - minicom
       - p7zip-full
       - zip
       - unzip
       - unrar
       - rar
       - xarchiver
       - mysql-workbench
       - sqlite3
       - libsqlite3-dev
       - gimp
       - gimp-plugin-registry
       - xsane
       - vim
       - vim-gtk
       - octave
       - qt-sdk
       - qt5-default
       - gdb
       - ruby
       - evince-gtk
       - openjdk-8-jdk
       - nasm
       - x11-utils
       - mysql-server
       - gedit
       - gedit-plugins
       - python-mysqldb
       - apache2
       - libapache2-mod-php
       - libapache2-mod-python
       - php-mysql
       - firmware-linux
       - cl-launch
       - sbcl
#       - clisp
#       - clisp-module-\*
       - swi-prolog
       - webstorm
       - clion
       - ghc
       - ghc-doc
       - ghc-dynamic
       - pidgin

    - name: adjust /var/www rights
      action: file mode=777 path=/var/www recurse=yes

    - name: deploy dosemu autoexec.bat
      copy: src=files/common/etc/dosemu/freedos/autoexec.bat dest=/etc/dosemu/freedos/autoexec.bat owner=root group=root mode="0644"

    - name: create test table in mysql
      action: mysql_db login_user=root login_password="" name=Test 
    
    - name: remove java6
      action: apt pkg={{item}} state=removed 
      with_items:
       - openjdk-6-jdk
       - openjdk-6-jre
       - openjdk-6-jre-headless
       - openjdk-6-jre-lib
       - default-jre-headless
       - default-jre

    
    - name: deploy nsswitch configuration files
      copy: src=files/a441/etc/hesiod.conf dest=/etc/hesiod.conf owner=root group=root mode="0644"

    - name: deploy hesiod configuration files
      copy: src=files/a441/etc/nsswitch.conf dest=/etc/nsswitch.conf owner=root group=root mode="0644"
    
    - name: deploy kerberos configuration files
      copy: src=files/a441/etc/krb5.conf dest=/etc/krb5.conf owner=root group=root mode="0644"

    - name: deploy admin access
      copy: src=files/a441/root/.k5login dest=/root/.k5login owner=root group=root mode="0644"

    - name: add pam group config
      copy: src=files/a441/etc/security/group.conf dest=/etc/security/group.conf owner=root group=distrib mode="0664"

#    - name: fix pam configs for auth
#      copy: src=files/a441/etc/pam.d/common-auth dest=/etc/pam.d/commion-auth owner=root group=root mode="0644"

    - name: install packages for time sync
      action: apt name={{item}} state=installed
      with_items:
       - openntpd
       - ntpdate

    - name: Install openntpd config
      template: src=templates/etc_openntpd_ntpd.conf.j2 dest=/etc/openntpd/ntpd.conf
      notify: restart openntpd

    - name: Install openntpd defaults
      copy: src=files/a441/etc/default/openntpd dest=/etc/default/openntpd
      notify: restart openntpd

#    - name: add virtual machines mount point
#      mount: fstype=ext4 name=/vm passno=2 src=/dev/mapper/a515-win7tmp state=mounted
    - include: tasks/install_internet.yml

    handlers:
    - include: handlers/restartopenntpd.yml
    - include: handlers/restartlightdm.yml
    - include: handlers/restartautofs.yml
    - include: handlers/restartapache.yml
